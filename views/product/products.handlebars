<link rel="stylesheet" href="/css/product.css">

<div class="container" style="padding-top: 50px;">
  <div class="bg-white rounded d-flex align-items-center justify-content-between" id="header"> <button class="btn btn-hide text-uppercase" type="button" data-bs-toggle="collapse" data-bs-target="#filterbar" aria-expanded="false" aria-controls="filterbar" id="filter-btn" onclick="changeBtnTxt()"> <span class="fas fa-angle-left" id="filter-angle"></span> <span id="btn-txt">Hide filters</span> </button>
    <nav class="navbar navbar-expand-lg navbar-light ps-lg-0 ps-auto"> <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mynav" aria-controls="mynav" aria-expanded="false" aria-label="Toggle navigation" onclick="chnageIcon()" id="icon"> <span class="navbar-toggler-icon"></span> </button>
      <div class="collapse navbar-collapse" id="mynav">
        <ul class="navbar-nav d-lg-flex align-items-lg-center">
          <li class="nav-item active"> 
            <select name="sort" id="sort">
              <option value="" hidden selected>Sort by</option>
                <option value="price">Highest Price</option>
              <option value="price">Highest Price</option>
              <option value="popularity">Lowest Price</option>
              <option value="rating">Rating</option>
            </select> </li>
          <li class="nav-item d-lg-none d-inline-flex"> </li>
        </ul>
      </div>
    </nav>
    <div class="ms-auto mt-3 me-2">
      <nav aria-label="Page navigation example">
        <ul class="pagination">
          <li class="page-item"> <a class="page-link" href="#" aria-label="Previous"> <span aria-hidden="true" class="fw-bold">&lt;</span> <span class="visually-hidden">Previous</span> </a> </li>
          <li class="page-item active"><a class="page-link" href="#">1</a></li>
          <li class="page-item"><a class="page-link" href="#">..</a></li>
          <li class="page-item"><a class="page-link" href="#">10</a></li>
          <li class="page-item"> <a class="page-link" href="#" aria-label="Next"> <span aria-hidden="true" class="fw-bold">&gt;</span> <span class="visually-hidden">Next</span> </a> </li>
        </ul>
      </nav>
    </div>
  </div>
  <div id="content" class="my-5">
    <div id="filterbar" class="collapse">
     <div class="box border-bottom">
        <div class="form-group text-center">
          <div class="btn-group" data-toggle="buttons"> <label class="btn btn-success form-check-label"> <input class="form-check-input" type="radio"> Reset </label> <label class="btn btn-success form-check-label active"> <input class="form-check-input" type="radio" checked> Apply </label> </div>
        </div>
      </div>
      <div class="box border-bottom">
        <div class="box-label text-uppercase d-flex align-items-center">Categories <button class="btn ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#inner-box" aria-expanded="false" aria-controls="inner-box" id="out" onclick="outerFilter()"> <span class="fas fa-plus"></span> </button> </div>
        <div id="inner-box" class="collapse mt-2 me-1">
          <div class="my-1"> <label class="tick">Food & Pantry<input type="checkbox"> <span class="check"></span> </label> </div>
          <div class="my-1"> <label class="tick">Bakery, Cereal & Spreads <input type="checkbox"> <span class="check"></span> </label> </div>
          <div class="my-1"> <label class="tick">Dairy, Chilled & Frozen <input type="checkbox"> <span class="check"></span> </label> </div>
          <div class="my-1"> <label class="tick">Snacks & Drinks <input type="checkbox"> <span class="check"></span> </label> </div>
          <div class="my-1"> <label class="tick">Health & Beauty <input type="checkbox"> <span class="check"></span> </label> </div>
          <div class="my-1"> <label class="tick">Mum & Baby <input type="checkbox" > <span class="check"></span> </label> </div>
          <div class="my-1"> <label class="tick">Fruits & Vegetables<input type="checkbox"> <span class="check"></span> </label> </div>
          <div class="my-1"> <label class="tick">Household & Pets <input type="checkbox" > <span class="check"></span> </label> </div>
        </div>
      </div>

      <div class="box border-bottom">
        <div class="box-label text-uppercase d-flex align-items-center">Brands <button class="btn ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#inner-box2" aria-expanded="false" aria-controls="inner-box2"><span class="fas fa-plus"></span></button> </div>
        <div id="inner-box2" class="collapse mt-2 me-1">
          <div class="my-1"> <label class="tick">Meiji<input type="checkbox"> <span class="check"></span> </label> </div>
          <div class="my-1"> <label class="tick">Sunshine <input type="checkbox"> <span class="check"></span> </label> </div>
          <div class="my-1"> <label class="tick">Kleenex <input type="checkbox" > <span class="check"></span> </label> </div>
          <div class="my-1"> <label class="tick">Lay's <input type="checkbox"> <span class="check"></span> </label> </div>
          <div class="my-1"> <label class="tick">Heinz <input type="checkbox"> <span class="check"></span> </label> </div>
          <div class="my-1"> <label class="tick">Dettol <input type="checkbox"> <span class="check"></span> </label> </div>
          <div class="my-1"> <label class="tick">Huggies <input type="checkbox"> <span class="check"></span> </label> </div>
          <div class="my-1"> <label class="tick">Cold Storage<input type="checkbox"> <span class="check"></span> </label> </div>
        </div>
      </div>

      <div class="box border-bottom">
        <div class="box-label text-uppercase d-flex align-items-center">price <button class="btn ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#price" aria-expanded="false" aria-controls="price"><span class="fas fa-plus"></span></button> </div>
        <div class="collapse" id="price">
          <div class="middle">
            <div class="multi-range-slider"> <input type="range" id="input-left" min="0" max="100" value="10"> <input type="range" id="input-right" min="0" max="100" value="50">
              <div class="slider">
                <div class="track"></div>
                <div class="range"></div>
                <div class="thumb left"></div>
                <div class="thumb right"></div>
              </div>
            </div>
          </div>
          <div class="d-flex align-items-center justify-content-between mt-2">
            <div> <span id="amount-left" class="fw-bold"></span> SGD </div>
            <div> <span id="amount-right" class="fw-bold"></span> SGD </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class = "products">
    <div class = "container">
        <div class = "product-items" style="">
            {{#product }}
            <div class = "product" style="width: 90%;">
                <div class = "product-content">
                    <div class = "product-img">
                        <a href="/product/details/{{id}}">
                            <img src = "/images/{{image}}" alt="{{product_name}}" alt = "product image">
                        </a>
                    </div>
                    <div class = "product-btns">
                      <button type = "button" class = "btn-buy" data-bs-toggle="modal" data-bs-target="#details_{{id}}"> details
                              <span><i class = "fas fa-shopping-cart"></i></span>
                      </button>
                    {{!-- modal --}}
                    <div class="modal" tabindex="-1" id="details_{{id}}" data-backdrop="static" data-bs-focus="false" >
                      <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content">
                          <div class="product-card" style="text-decoration: none;">
                            <div class="image-container" style="text-decoration: none;">
                              <div class="cover-image product-image">
                                <img src="/images/{{image}}" alt="{{product_name}}">
                              </div>
                            </div>
                            <div class="product-info">
                              <p class="free-shipping" style="text-decoration: none;">Free Delivery</p>
                              <h3 class="product-name">{{product_name}}</h3>
                              <p class="regular-price">{{discount}} % OFF </p>
                              <p class="discount-price">${{product_price}}</p>
                              <p class="offer-info">{{desc}}</p>
                              <form action="/cart/add/{{id}}" method="post">
                              <input type="hidden" name="" value="">
                              <button type = "submit" class="add-to-cart" style="text-decoration: none;">
                                <ion-icon name="add-outline"></ion-icon> Add to cart
                              </button>
                              <div class="stock">
                                <div class="stock-status"></div>
                                <p class="stock-info">Stock: {{stock}}</p>
                              </div>
                              <div class="buttons">
                                  <button type = "submit" class = "button" value="{{id}}"> 
                                      <ion-icon name="bag-add-outline"></ion-icon> Add to cart
                                  </button>
                                  <input type="hidden" name="quantity" value="1">
                                <a href="#" class="button" style="text-decoration: none;">
                                  <ion-icon name="heart-outline"></ion-icon> Add to wishlist
                                </a>
                              </form>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                {{!-- end of modal --}}
                      {{!-- {{#if product.stock > 0 }} --}}
                      <form action="/cart/add/{{id}}" method="post">
                          <input type="hidden" name="" value="">
                          <button type = "submit" class = "btn-cart" value="{{id}}"> add to cart
                              <span><i class = "fas fa-plus"></i></span>
                          </button>
                          <input type="hidden" name="quantity" value="1">
                      </form>
                      {{!-- {{# product.stock == 0 or product.stock < 0 }}
                          <button type="submit" disabled class="btn btn-danger float-end">Out of Stock</button>
                      {{/if }} --}}


                    </div>
                </div>

                <div class = "product-info">
                    <div class = "product-info-top">
                        <h2 class = "sm-title">Brand</h2>
                        <div class = "rating">
                            <span><i class = "fas fa-star"></i></span>
                            <span><i class = "fas fa-star"></i></span>
                            <span><i class = "fas fa-star"></i></span>
                            <span><i class = "fas fa-star"></i></span>
                            <span><i class = "far fa-star"></i></span>
                        </div>
                    </div>
                    <a href = "/product/details/{{id}}" class = "product-name">{{product_name}}</a>
                    <p class = "product-price">$ test</p>
                    <p class = "product-price">$ {{product_price}}</p>
                </div>
                <div class = "off-info">
                    <h2 class = "sm-title">{{discount}}% off</h2>
                </div>
            </div>
            {{/product}}
        </div>

        </div>
    </div>
</div>
<div class="row" style="padding: 30px;">
<div class="col text-center">
{{#if products.has_prev }}
    <a href=""class="btn mt-3 btn-outline-info">Previous</a>
{{/if }}
{{!-- {{ #if products.total > 8 }} --}}
{{!-- {{#each page_num in products.iter_pages(left_edge=1, right_edge=2, left_current=1, right_current=2) }}
{{ #if page_num }}
{{ #if products.page == page_num }}
<a href="" class="btn btn mt-3 btn-info">{{page_num}}</a>
{{#else }}
<a href="" class="btn btn mt-3 btn-outline-info">{{page_num}}</a>
{{/if }} --}}
{{!-- {{#else }}
...
{{/if }} --}}
{{!-- {{/if }}
{{ #if products.has_next }}
<a href="{{url_for('home', page=products.next_num)}}"class="btn  mt-3 btn-outline-info">Next</a>
{{/if }} --}}
</div>

<script>

document.addEventListener("DOMContentLoaded", function () {
  var inputLeft = document.getElementById("input-left");
  var inputRight = document.getElementById("input-right");

  var thumbLeft = document.querySelector(".slider > .thumb.left");
  var thumbRight = document.querySelector(".slider > .thumb.right");
  var range = document.querySelector(".slider > .range");

  var amountLeft = document.getElementById("amount-left");
  var amountRight = document.getElementById("amount-right");

  function setLeftValue() {
    var _this = inputLeft,
      min = parseInt(_this.min),
      max = parseInt(_this.max);

    _this.value = Math.min(
      parseInt(_this.value),
      parseInt(inputRight.value) - 1
    );

    var percent = ((_this.value - min) / (max - min)) * 100;

    thumbLeft.style.left = percent + "%";
    range.style.left = percent + "%";
    amountLeft.innerText = parseInt(percent * 1);
  }
  setLeftValue();

  function setRightValue() {
    var _this = inputRight,
      min = parseInt(_this.min),
      max = parseInt(_this.max);

    _this.value = Math.max(
      parseInt(_this.value),
      parseInt(inputLeft.value) + 1
    );

    var percent = ((_this.value - min) / (max - min)) * 100;

    amountRight.innerText = parseInt(percent * 1);
    thumbRight.style.right = 100 - percent + "%";
    range.style.right = 100 - percent + "%";
  }
  setRightValue();

  inputLeft.addEventListener("input", setLeftValue);
  inputRight.addEventListener("input", setRightValue);

  inputLeft.addEventListener("mouseover", function () {
    thumbLeft.classList.add("hover");
  });
  inputLeft.addEventListener("mouseout", function () {
    thumbLeft.classList.remove("hover");
  });
  inputLeft.addEventListener("mousedown", function () {
    thumbLeft.classList.add("active");
  });
  inputLeft.addEventListener("mouseup", function () {
    thumbLeft.classList.remove("active");
  });

  inputRight.addEventListener("mouseover", function () {
    thumbRight.classList.add("hover");
  });
  inputRight.addEventListener("mouseout", function () {
    thumbRight.classList.remove("hover");
  });
  inputRight.addEventListener("mousedown", function () {
    thumbRight.classList.add("active");
  });
  inputRight.addEventListener("mouseup", function () {
    thumbRight.classList.remove("active");
  });
});
    function submitForm(element){
        var id = element.value;
        $.ajax({
            url : '/product/wishlist',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({id: id}),
            success: function(res){
                if (res.status == "add"){
                    // element.classList.remove("bx-bookmarks")
                    element.classList.add('bxs-bookmark')
                    element.classList.add('bx-tada')
                    setTimeout(function(){element.classList.remove('bx-tada')}, 1000)
                } else if (res.status == "remove") {
                    // element.classList.add("bi-bookmarks")
                    element.classList.remove('bxs-bookmark')
                    element.classList.add('bx-tada')
                    setTimeout(function(){element.classList.remove('bx-tada')}, 1000)
                }else{
                    fireLogin(element)
                }
            },
        })
    }

function fireLogin(element){
    Swal.fire({
        title: 'Login Form',
        html: `<input type="text" id="login" class="swal2-input" placeholder="Username">
        <input type="password" id="password" class="swal2-input" placeholder="Password">`,
        confirmButtonText: 'Sign in',
        focusConfirm: true,
        preConfirm: () => {
            const login = Swal.getPopup().querySelector('#login').value
            const password = Swal.getPopup().querySelector('#password').value
            if (!login || !password) {
            Swal.showValidationMessage(`Please enter login and password`)
            }
            return { login: login, password: password }
        }
        }).then((result) => {
            $.ajax({
                type: 'POST',
                data:{
                    email: result.value.login,
                    password: result.value.password
                },
                url: '/user/login',
            }).then((result) => {checkStatus(result, element)})
        })
    }

function checkStatus(result, element){
    $.ajax({
        type: 'POST',
        url: '/user/checkStatus',
        success: function(res){
            if(res.status == 'logged in'){
                swal.fire({
                    title: "logging in ",
                    timer: 1000,
                    didOpen: () => {
                    Swal.showLoading()
                    const b = Swal.getHtmlContainer().querySelector('b')
                    timerInterval = setInterval(() => {
                    b.textContent = Swal.getTimerLeft()
                    }, 100)
                }
                })
                setTimeout(function(){swal.fire("logged in"), submitForm(element) }, 1500)
            }else if(res.status == "not logged in"){
                swal.fire("invalid login")
            }
        }
    })
}
/*$(window).scroll(function() {
    if($(window).scrollTop() == $(document).height() - $(window).height()) {
        const params = new URLSearchParams(window.location.search)
        page = parseInt(params.get('page'))
        if(isNaN(page)){
            page = 0
        }
        page +=1
        new_url ='/product/nextpage?page='+String(page)
           $.ajax({
            type: 'GET',
            url: new_url,
            success: function(data){
                $(".product-items").append(JSON.stringify(data))
                    image = '<img src="/images/'+ data['product'][0]['image'] + '">'
                    id = data['product'][0]['id']
                    modal = "#details_" + id
                    image_id = "<div class='product-img'><a href='"+modal+"' data-bs-toggle='modal'>"+image+"</a>"
                    $(".product-items").append("<div class='product'>"+image_id+"</div>")
                
            }
           })
    }
});*/
function getParameterByName(name, url = window.location.href) {
    name = name.replace(/[\[\]]/g, '\\$&');
    var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, ' '));
}
var page = 1;
var working = false;
var search = getParameterByName('search');
if(search == null){
    search =""
}
$(window).scroll(function() {
    if(working == false){
        working = true;

        $.ajax({
            type: "GET",
            url: "/product/nextpage?search="+search+"&page="+page,
            processData: false,
            contentType: "application/json",
            data: '',
            success: function(data){
                for(var a in data['product']){
                    image = '<img src="/images/'+ data['product'][a]['image'] + '">'
                    id = data['product'][a]['id']
                    price = data['product'][a]['product_price']
                    discount = parseFloat(data['product'][a]['discount'])
                    stock = data['product'][a]['stock']
                    if(discount > 0){
                        price_info = `<p class = "product-price">$`+price+`</p>
                                      <p class = "product-price">$`+parseFloat(parseFloat(price) * ((100-parseFloat(discount))/100)).toFixed(2)+`</p>
                                      </div>
                                      <div>
                                        <div class="off-info">
                                            <h2 class = "sm-title">`+discount+`% off</h2>
                                      </div>`
                        modal_discount = `<p style="font-size: 21px; color: #f05229; font-weight: 600; line-height: 37.8px; vertical-align:top; text-align: left;">`+data['product'][a]['discount']+`% OFF </p>`
                    }else{
                        price_info = `<p class = "product-price"></p>
                                      <p class = "product-price">$`+parseFloat(parseFloat(price) * ((100-parseFloat(discount))/100)).toFixed(2)+`</p>
                                      </div>`
                        modal_discount = ""
                    }
                    if(stock>0){
                        modal_stock = `<input type="hidden" name="product_id" value="{{id}}">
                                                <div class="form-group">
                                                    <button type="submit" class="btn btn-sm btn-warning">Add to Cart</button>
                                                    <label for="quantity">Quantity: </label>
                                                    <input type="number" id="quantity" name="quantity" value="1" min="1" max="{{stock}}" />
                                                </div>`
                    }else{
                        modal_stock = `<button type="submit" disabled class="btn btn-sm btn-danger">Out of Stock</button>`
                    }
                    modal_id = "#details_" + id
                    btns = `<div class = "product-btns">
                        <button class="btn-buy" style=style="text-decoration: none; color:black; text-align:center;" data-bs-toggle="modal" data-bs-target="`+modal_id+`">
                            details<span><i class = "fa fa-shopping-cart"></i></span></button>`
                    form = `<form action=/cart/add/{{id}}" method="post">
                            <input type="hidden" name="" value="">
                            <button type="submit" class="btn-cart" value="`+id+`"> add to cart</button>
                            <input type="hidden" name=quantity value="1"
                            </form></div>`

                    productInfo = `<div class="product-info">
                                        <div class="product-info-top">
                                            <h2 class = "sm-title">`+data['product'][a]["brand.brand_name"]+`</h2>
                                            <div class="rating" style="">
                                                <span><i class= "fas fa-star"></i></span>
                                                <span><i class= "fas fa-star"></i></span>
                                                <span><i class= "fas fa-star"></i></span>
                                                <span><i class= "fas fa-star"></i></span>
                                                <span><i class= "fas fa-star"></i></span>
                                            </div>
                                        </div>
                                        <a href= "/product/details/`+id+`" class="product-name">`+data['product'][a]['product_name']+`</a>
                                        `+price_info
                    modal = `<div class="modal" tabindex="-1" id="details_`+id+`" data-backdrop="static" data-bs-focus="false">
                            <div class="modal-dialog modal-lg modal-dialog-centered">
                            <div class="modal-content">
                            <div class="modal-header"style="background-color:white"><h4>Item Detail</h4>
                            <button type="submit" class="close fa-2x" data-bs-dismiss="modal" aria-label="Close" style="background-color:white"><span aria-hidden="true">&times;</span></button>
                            </div>
                            <div class="modal-footer" style="background-color:white">
                                <div class="row">
                                    <div class="col-md-6" id="b_image">
                                        <img src="/images/`+data['product'][a]['image']+`" alt="`+data['product'][a]['product_name']+`">
                                    </div>
                                    <div class="col-md-6">
                                        <div style="float:right!important">
                                            <button value=`+id+` class="btn btn-sm bx bx-bookmark" onclick="submitForm(this)" style="font-size:2rem"></button>
                                        </div>
                                        <p style="font-size: 32px; color: #319e40; font-weight: 500; line-height: 32px; vertical-align:top; text-align: left;">`+data['product'][a]['product_price']+`</p>
                                        `+modal_discount+`
                                        <p style="font-size: 24px; color: #4a4a4a; font-weight: 400; line-height: 24px; vertical-align: top; text-align: left; padding: 0px;">`+data['product'][a]['product_name']+`</p>
                                        <hr>
                                        <p style="font-size: 16px; color: #4a4a4a; font-weight: 400; line-height: 24px; vertical-align: top; text-align: left; margin: 0px 0px 30px;">`+data['product'][a]['desc']+`</p>
                                        <div style="float: left">
                                        <form action="/cart/add/`+id+`" method="post">
                                            `+modal_stock+`
                                        </form>
                                            <h4 style="float: right">Stock: `+data['product'][a]['stock']+`</h4>
                                    </div>
                                </div>
                            </div>
                            </div>
                            </div>
                            </div>`
                    image_id = "<div class='product-img'><a href='"+ modal_id+"' data-bs-toggle='modal'>"+image+"</a>"                                                                                                                                                                                                     
                    $(".product-items").append(`<div class='product'><div class="product"><div class="product-content">`+image_id+"</div>"+btns+form+`</div></div>`+productInfo)
                    $('body').append(modal)
                }
                page += 1
                setTimeout(function(){
                    working = false;
                }, 1000)
            }
            })
    }
})

</script>

<script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>

